<!DOCTYPE html>
<html lang='fr'>
  <head>
    <meta charset='UTF-8'/>
    <title>Fabriquer un photomaton avec un Raspberry Pi</title>
    <link rel="stylesheet" href="iosevka.css">
    <link rel='stylesheet' href='responsive.css'/>
    <script src="prefixfree.min.js"></script>
    <meta name='viewport'content='width=device-width, initial-scale=1.0, maximum-scale=1.0'/>
  </head>
  <body>
    <div class='page'>
      <div class='section menu'>
        <div class="menu">
  
  <div><a href="/ksp.html" >tutoriels</a></div>
  
  <div><a href="/docs.html" >guides et documentation</a></div>
  
  <div><a href="/infos.html" >infos pratiques</a></div>
  
</div>

      </div>
      <div class='section header'></div>
      <div class='section contenu'>
        <h1 id="fabriquer-un-photomaton-avec-un-raspberry-pi">Fabriquer un photomaton avec un Raspberry Pi</h1>

<p>[!] - rédiger rapidement - à revérifier et à corriger - [!]</p>

<p><a href="https://learn.adafruit.com/instant-camera-using-raspberry-pi-and-thermal-printer/system-setup">[source]</a></p>

<p>Afin de fabriquer un photomation il faut plusieurs éléments : de quoi prendre des photos, de quoi les imprimer et de quoi déclencher le tout.</p>

<p>Pour faire cela tout allons utiliser une webcam ou une camera Pi, une imprimante thermique et un bouton. Mais le plus important, pour relier tout ça ensemble, nous allons utiliser un Raspberry Pi.</p>

<h4 id="les-composants-">Les composants :</h4>

<ul>
  <li>Un Raspberry Pi
    <ul>
      <li>Avec un alimentation 5 V et 2 à 3 A</li>
      <li>Une Carte microSD (2Go minimum)</li>
    </ul>
  </li>
  <li>Une Raspberry Pi Cam ou webcam</li>
  <li>Une Imprimante thermique
    <ul>
      <li>Les cables ou fils necessaire pour l’alimenter et communiquer avec (dépend du modèle)</li>
      <li>Des rouleaux de papier thermique</li>
    </ul>
  </li>
  <li>Et un bouton poussoir</li>
</ul>

<h5 id="pour-la-mise-en-place-vous-aurez-besoin-">Pour la mise en place vous aurez besoin :</h5>

<ul>
  <li>D’un ordinateur avec une connexion internet</li>
  <li>D’un lecteur de carte SD et un adaptateur microSD vers SD</li>
  <li>Un écran et un cable HDMI</li>
  <li>Un Clavier et une souris</li>
  <li>Un cable ethernet ou un accès WiFi (pour le Raspberry Pi, si son modèle le permet)</li>
  <li>Des cables jumper ou du fil électrique</li>
</ul>

<p>Maitenant qu’on a tout il ne reste plus qu’a s’y mettre et construire notre photomaton.</p>

<h2 id="préparation-et-configuration-du-raspberry-pi">Préparation et configuration du Raspberry Pi</h2>

<p>::10 à 20 minutes::</p>

<p>On va commencer par préparer notre Raspberry Pi car il est vide et pas configurer pour l’usage que l’on va en faire.</p>

<h4 id="installation-du-système-dexploitation-sur-carte-sd">Installation du système d’exploitation sur carte SD</h4>

<p>Sans système de logique ou d’exploitation la machine n’est rien qu’un tas de composants avec lesquelles il est difficile d’interagir. Alors on va télécharger le système d’exploitation Raspbian et un utilitaire pour nous permettre de la graver sur notre carte microSD.</p>

<p>Lien vers Raspbian</p>

<p>Lien vers Etcher</p>

<h4 id="configuration-de-raspbian">Configuration de Raspbian</h4>

<p>Config….</p>

<p>Langue, timezone etc…</p>

<p><code class="highlighter-rouge">raspi-config</code></p>

<p>optionnel mais recommandé :</p>

<p>sous “options d’internationalisation” configurer le clavier pour convenir à vos besoins. Si les saisis sont étranges et inattendues, le soucis provient surement de là.</p>

<p>changer le mot de passe</p>

<p>une fois ceci fait on peut redémarrer le Raspberry Pi pour attaque le reste</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reboot
</code></pre></div></div>

<p>Choisir l’utilisateur “pi” avec le mot de passe que vous avez choisi ou celui par défaut “raspberry”</p>

<p>..petit texte de transition ?…</p>

<hr />

<h2 id="la-camera">La camera</h2>

<p>::10 minutes::</p>

<p>En fonction de si on a une webcam USB ou un module caméra pour Raspberry Pi cette étape change légèrement. Mais l’idée reste la même, on va apprendre à prendre des photos avec l’interface en ligne de commande !</p>

<h4 id="installation-des-packets">Installation des packets</h4>

<p>Si on a une webcam USB il faut installer le packet <code class="highlighter-rouge">fswebcam</code> afin de pouvoir demander au Raspberry de prendre des photos avec.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install fswebcam
</code></pre></div></div>

<p>La commande <code class="highlighter-rouge">raspistill</code> est préinstallé sur Raspbian et donc ne nécessite pas l’installation de packets supplémentaires.</p>

<h4 id="test-de-la-caméra">Test de la caméra</h4>

<p>Maintenant que tout est installé on va prendre des photos pour s’assurer que ça marche bien.</p>

<p>Pour le module caméra Raspberry Pi c’est :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>raspistill -vf -hf -o photo.jpg
</code></pre></div></div>

<p>Et avec une webcam USB c’est :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fswebcam photo.jpg
</code></pre></div></div>

<p>Notre image que l’on a nomé photo.jpg se retrouve alors dans le repertoire <code class="highlighter-rouge">/home/pi/</code> (celui sur lequel on retourne quand on clique sur la petite maison).</p>

<h4 id="approfondissement-des-commandes">Approfondissement des commandes</h4>

<p>/vers/repertoire/photo.jpg : pour enregistrer la photo dans un repertoire précis</p>

<h5 id="raspistill">raspistill</h5>

<p>description <code class="highlighter-rouge">-vf</code> et <code class="highlighter-rouge">-hf</code> : vertical flip et horizontal flip (sinon photo = à l’envers)</p>

<h5 id="fswebcam">fswebcam</h5>

<p><code class="highlighter-rouge">--no-banner</code> : pour ne pas avoir la bannière en bas avec la date etc..</p>

<p><code class="highlighter-rouge">-r 1280x720</code> : pour définir la résolution (doit être en adequation avec le format de la webcam sinon sa résolution sera modifiée au rapport de forme le plus proche)</p>

<p>exemple :
pour prendre une photo à la webcam et la sauvegarder sans la bannière dans <em>mondossier</em> il faut écrire :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fswebcam --nobanner /mondossier/photo.jpg
</code></pre></div></div>
<hr />

<h2 id="limprimante">L’imprimante</h2>

<p>::20 minutes::</p>

<h4 id="installation-des-packets-1">Installation des packets</h4>

<p>téléchargement des packets généraux dont le paquet CUPS (Common UNIX Printing System) qui gère l’interface avec l’imprimante ainsi que quelques autres outils.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get update
sudo apt-get install git cups wiringpi build-essential libcups2-dev libcupsimage2-dev
</code></pre></div></div>

<p>téléchargement du filtre CUPS qui permet de traduire les images bitmap au format natif des imprimantes thermiques</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd
git clone https://github.com/adafruit/zj-58
cd zj-58
make
sudo ./install
</code></pre></div></div>

<h4 id="configuration-de-limprimante-par-defaut">Configuration de l’imprimante par defaut</h4>

<p>– savoir le baud rate de l’imprimante –</p>

<p>pour ajouter l’imprimante et la choisir par défaut :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo lpadmin -p ZJ-58 -E -v serial:/dev/ttyAMA0?baud=9600 -m zjiang/ZJ-58.ppd
sudo lpoptions -d ZJ-58
</code></pre></div></div>

<p>changer la valeur de “baud” en fonction l’imprimante, 9600 ou 19200.</p>

<p>Pour une imprimante USB, changer le nom de l’imprimante à <code class="highlighter-rouge">/dev/ttyUSB0</code></p>

<p>Pour toute autres imprimantes utiliser le nom <code class="highlighter-rouge">/dev/ttyAMA0</code> ou <code class="highlighter-rouge">/dev/serial0</code></p>

<h4 id="essais-dimpression-de-texte-et-dimages">Essais d’impression de texte et d’images</h4>

<hr />

<h2 id="photomat">Photomat’</h2>

<h4 id="création-dun-script">Création d’un script</h4>

<p>pour automatiser la prise de photo + impression</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># prendre photo</span>
<span class="c"># imprimer ici.....</span>
</code></pre></div></div>

<p>lui donner le nom qu’on veut (ex: <code class="highlighter-rouge">monscript.sh</code>)</p>

<p>modifier les droits pour le rendre executable</p>

<p>puis pour l’executer <code class="highlighter-rouge">./monscript.sh</code></p>

<h4 id="amélioration-du-script">Amélioration du script</h4>

<p>ajout de bouton et autres options, lancement du script au boot et finitions.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">BOUTON</span><span class="o">=</span>16

<span class="c"># initialisation du GPIO</span>
gpio <span class="nt">-g</span> mode  <span class="nv">$BOUTON</span> up

<span class="k">while</span> :
<span class="k">do</span>
	<span class="c"># si [le bouton est appuyé]; alors</span>
	<span class="k">if</span> <span class="o">[</span> <span class="si">$(</span>gpio <span class="nt">-g</span> <span class="nb">read</span> <span class="nv">$BOUTON</span><span class="si">)</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    		<span class="c">#insérer premier script ici#</span>
    <span class="k">fi
done</span>
</code></pre></div></div>

<hr />

<h5 id="configuration-du-démarrage-automatique">Configuration du démarrage automatique</h5>

<p>Nous allons faire en sorte que le script de la camera démarre tout seul quand le Raspberry démarre.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nano /etc/rc.local
</code></pre></div></div>

<p>Juste avant la dernière ligne “exit 0” écrire la ligne suivante :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh /home/monscript.sh
</code></pre></div></div>

<p>Sauvegarder et quitter l’editeur de texte nano.</p>

      </div>
      <div class='section footer'></div>
    </div>
  </body>
</html>
